services:
  gateway:
    build:
      context: ./apps/gateway
    ports:
      - "8000:8000"
    environment:
      - GATEWAY_ROUTES=[{"name":"auth","path":"/auth","upstream":"http://auth:8000/auth"},{"name":"inventory","path":"/inventory","upstream":"http://inventory:8000"},{"name":"cabinets","path":"/cabinets","upstream":"http://location:8000"},{"name":"departments","path":"/departments","upstream":"http://departments:8000/departments"}]
      - ENV=development
    depends_on:
      - auth
      - location
      - departments

  web:
    build:
      context: .
      target: dev
    ports:
      - "5173:5173"
    volumes:
      - ./apps/web:/app
      - web_node_modules:/app/node_modules
    environment:
      - CHOKIDAR_USEPOLLING=true
      - VITE_API_PROXY_TARGET=http://gateway:8000

  web_prod:
    build:
      context: .
      target: prod
    ports:
      - "8080:80"
    depends_on:
      - gateway

  auth:
    build:
      context: ./apps/auth
    ports:
      - "8001:8000"
    env_file:
      - .env
    depends_on:
      postgres:
        condition: service_healthy
    command: >
      sh -c "alembic upgrade head &&
      uvicorn app.main:app --host 0.0.0.0 --port 8000"

  postgres:
    image: postgres:16-alpine
    ports:
      - "5432:5432"
    env_file:
      - .env
    volumes:
      - ./docker/postgres:/docker-entrypoint-initdb.d
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 10

  inventory:
    build:
      context: ./apps/inventory-service
      dockerfile: docker/Dockerfile
    ports:
      - "8002:8000"
    env_file:
      - .env
    environment:
      - INVENTORY_DATABASE_URL=postgresql+psycopg://auth:auth@postgres:5432/inventory
    depends_on:
      postgres:
        condition: service_healthy
    command: >
      sh -c "alembic upgrade head &&
      uvicorn app.main:app --host 0.0.0.0 --port 8000"

  location:
    build:
      context: ./apps/location-service
      dockerfile: docker/Dockerfile
    ports:
      - "8003:8000"
    env_file:
      - .env
    environment:
      - LOCATION_DATABASE_URL=postgresql+psycopg://auth:auth@postgres:5432/location
    depends_on:
      postgres:
        condition: service_healthy
    command: >
      sh -c "alembic upgrade head &&
      uvicorn app.main:app --host 0.0.0.0 --port 8000"

  departments:
    build:
      context: ./apps/departments-service
      dockerfile: docker/Dockerfile
    ports:
      - "8004:8000"
    env_file:
      - .env
    environment:
      - DEPARTMENTS_DATABASE_URL=postgresql+psycopg://auth:auth@postgres:5432/departments
    depends_on:
      postgres:
        condition: service_healthy
    command: >
      sh -c "alembic upgrade head &&
      uvicorn app.main:app --host 0.0.0.0 --port 8000"

volumes:
  web_node_modules: {}
  postgres_data: {}
